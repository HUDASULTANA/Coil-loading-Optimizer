<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Coil Loading Optimizer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        
        .input-section h2 {
            color: #2c3e50;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        textarea, input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }
        
        .fleet-config {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 2px solid #3498db;
        }
        
        .fleet-item {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .fleet-basic-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .fleet-basic-info > div {
            flex: 1;
        }
        
        .position-constraints {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .position-constraints h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 14px;
        }
        
        .position-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .position-input {
            text-align: center;
        }
        
        .position-input label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #666;
        }
        
        .position-input input {
            padding: 8px;
            font-size: 12px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .optimize-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .remove-btn {
            background: #e74c3c;
            min-width: auto;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border-left: 5px solid #27ae60;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #ecf0f1;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00b894;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Efficiency Display Styles */
        .efficiency-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 3px solid #e9ecef;
        }
        
        .efficiency-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .efficiency-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5em;
        }
        
        .efficiency-chart {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .efficiency-category {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 1;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .efficiency-category:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .efficiency-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            position: relative;
            flex-shrink: 0;
            margin-bottom: 10px;
            background: transparent;
        }
        
        .efficiency-high {
            color: #00b894;
        }
        
        .efficiency-medium {
            color: #fdcb6e;
        }
        
        .efficiency-low {
            color: #fd79a8;
        }
        
        .efficiency-unused {
            color: #74b9ff;
        }
        
        .efficiency-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 10px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .efficiency-description {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .efficiency-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
            flex-shrink: 0;
            min-width: 16px;
            min-height: 16px;
        }
        
        .efficiency-indicator.high {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }
        
        .efficiency-indicator.medium {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }
        
        .efficiency-indicator.low {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }
        
        .efficiency-indicator.unused {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }
        
        /* Visual Wagon Display Styles */
        .visual-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border-left: 5px solid #9b59b6;
        }
        
        .wagon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .wagon-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 3px solid #00b894;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .wagon-card.medium-efficiency {
            border-color: #fdcb6e;
        }
        
        .wagon-card.low-efficiency {
            border-color: #fd79a8;
        }
        
        .wagon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .wagon-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .wagon-efficiency {
            background: #00b894;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .wagon-efficiency.medium {
            background: #fdcb6e;
            color: #2d3436;
        }
        
        .wagon-efficiency.low {
            background: #fd79a8;
            color: white;
        }
        
        .wagon-layout {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 80px;
        }
        
        .coil-position {
            flex: 1;
            background: #74b9ff;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-weight: bold;
            color: white;
            text-align: center;
            min-height: 60px;
        }
        
        .coil-position.front {
            background: #00b894;
        }
        
        .coil-position.middle {
            background: #a29bfe;
        }
        
        .coil-position.rear {
            background: #00b894;
        }
        
        .coil-position.empty {
            background: #f8f9fa;
            color: #636e72;
            border: 2px dashed #ddd;
        }
        
        .efficiency-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin: 15px 0 5px 0;
            overflow: hidden;
        }
        
        .efficiency-progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .efficiency-progress.high {
            background: linear-gradient(90deg, #00b894, #00cec9);
        }
        
        .efficiency-progress.medium {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }
        
        .efficiency-progress.low {
            background: linear-gradient(90deg, #fd79a8, #e84393);
        }
        
        .coil-id {
            font-size: 14px;
            font-weight: bold;
        }
        
        .coil-weight {
            font-size: 12px;
            margin-top: 2px;
        }
        
        .wagon-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }
        
        /* Export Section Styles */
        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #27ae60;
        }
        
        .csv-display {
            background: white;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .csv-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre;
            color: #2c3e50;
        }
        
        /* Terminal Output Styles */
        .output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            margin-top: 10px;
        }
        
        .emoji {
            font-size: 1.2em;
        }
        
        .hidden {
            display: none;
        }
        
        .test-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .test-section h3 {
            color: #856404;
            margin-top: 0;
        }
        
        .constraint-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #2196f3;
        }
        
        .constraint-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .constraint-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .constraint-info li {
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="emoji">üöõ</span> Enhanced Coil Loading Optimizer <span class="emoji">‚öñÔ∏è</span></h1>
        
        <div class="constraint-info">
            <h4><span class="emoji">üìã</span> Loading Constraints</h4>
            <ul>
                <li><strong>3-Coil Loading:</strong> End coils weight difference ‚â§ 2 tons, middle coil lighter than both ends</li>
                <li><strong>2-Coil Loading:</strong> Weight difference ‚â§ 2 tons</li>
                <li><strong>Position Limits:</strong> Each position has maximum weight constraints per wagon type</li>
                <li><strong>Priority:</strong> Minimum 2 coils per wagon when possible</li>
            </ul>
        </div>
        
        <div class="input-section">
            <h2><span class="emoji">üìã</span> Input Configuration</h2>
            
            <label for="coilData">Coil Data (Format: One coil per line - Coil,Weight):</label>
            <textarea id="coilData" rows="8" placeholder="Enter coil data (one per line)...
C001,23.24
C002,31.31
C003,28.25
...">C001,23.24
C002,31.31
C003,28.25
C004,26.38
C005,20.18
C006,20.18
C007,18.81
C008,30.13
C009,26.42
C010,27.91
C011,18.29
C012,31.58
C013,29.65
C014,20.97
C015,20.55
C016,20.57
C017,22.26
C018,25.35
C019,24.05
C020,22.08
C021,26.57
C022,19.95
C023,22.09
C024,23.13
C025,24.38
C026,28.99
C027,20.8
C028,25.2
C029,26.29
C030,18.65</textarea>
            
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div style="flex: 1;">
                    <label for="wagonType">Wagon Configuration:</label>
                    <select id="wagonType" onchange="toggleFleetConfig()">
                        <option value="single">BFNV</option>
                        <option value="mixed">Concord</option>
                    </select>
                </div>
                
                <div style="flex: 1;">
                    <label for="maxWeightDiff">Max Weight Difference (tons):</label>
                    <input type="number" id="maxWeightDiff" value="2.0" step="0.1" min="0">
                </div>
            </div>
            
            <div id="singleWagonConfig" style="margin-top: 20px;">
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label for="wagonCapacity">Wagon Capacity (tons):</label>
                        <input type="number" id="wagonCapacity" value="68.6" step="0.1" min="1">
                    </div>
                    <div style="flex: 1;">
                        <label for="numWagons">Number of Wagons:</label>
                        <input type="number" id="numWagons" value="15" min="1">
                    </div>
                </div>
                
                <div class="position-constraints">
                    <h4>Position Weight Limits (tons)</h4>
                    <div class="position-row">
                        <div class="position-input">
                            <label>Position 1 (Front)</label>
                            <input type="number" id="singlePos1" value="32" step="0.1" min="0">
                        </div>
                        <div class="position-input">
                            <label>Position 2 (Middle)</label>
                            <input type="number" id="singlePos2" value="23" step="0.1" min="0">
                        </div>
                        <div class="position-input">
                            <label>Position 3 (Rear)</label>
                            <input type="number" id="singlePos3" value="32" step="0.1" min="0">
                        </div>
                    </div>
                </div>
            </div>
            
                            <div id="mixedFleetConfig" class="fleet-config">
                <h3>Concord Fleet Configuration:</h3>
                <div id="fleetItems">
                    <div class="fleet-item">
                        <div class="fleet-basic-info">
                            <div>
                                <label>Wagon Type:</label>
                                <input type="text" placeholder="e.g., BOST" value="BOST">
                            </div>
                            <div>
                                <label>Capacity (tons):</label>
                                <input type="number" placeholder="65.1" value="65.1" step="0.1">
                            </div>
                            <div>
                                <label>Count:</label>
                                <input type="number" placeholder="8" value="8" min="1">
                            </div>
                        </div>
                        <div class="position-constraints">
                            <h4>Position Weight Limits (tons)</h4>
                            <div class="position-row">
                                <div class="position-input">
                                    <label>Position 1 (Front)</label>
                                    <input type="number" value="32" step="0.1" min="0">
                                </div>
                                <div class="position-input">
                                    <label>Position 2 (Middle)</label>
                                    <input type="number" value="22" step="0.1" min="0">
                                </div>
                                <div class="position-input">
                                    <label>Position 3 (Rear)</label>
                                    <input type="number" value="32" step="0.1" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fleet-item">
                        <div class="fleet-basic-info">
                            <div>
                                <label>Wagon Type:</label>
                                <input type="text" placeholder="e.g., BRN" value="BRN">
                            </div>
                            <div>
                                <label>Capacity (tons):</label>
                                <input type="number" placeholder="62.6" value="62.6" step="0.1">
                            </div>
                            <div>
                                <label>Count:</label>
                                <input type="number" placeholder="6" value="6" min="1">
                            </div>
                        </div>
                        <div class="position-constraints">
                            <h4>Position Weight Limits (tons)</h4>
                            <div class="position-row">
                                <div class="position-input">
                                    <label>Position 1 (Front)</label>
                                    <input type="number" value="32" step="0.1" min="0">
                                </div>
                                <div class="position-input">
                                    <label>Position 2 (Middle)</label>
                                    <input type="number" value="22" step="0.1" min="0">
                                </div>
                                <div class="position-input">
                                    <label>Position 3 (Rear)</label>
                                    <input type="number" value="32" step="0.1" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addFleetItem()">+ Add Wagon Type</button>
            </div>
        </div>
        
        <div class="buttons">
            <button class="optimize-btn" onclick="runOptimization()">
                <span class="emoji">üéØ</span> Optimize Loading
            </button>
            <button onclick="runExample()">
                <span class="emoji">üß™</span> Run Example Test
            </button>
            <button onclick="clearResults()">
                <span class="emoji">üóëÔ∏è</span> Clear Results
            </button>
        </div>
        
        <div class="test-section">
            <h3><span class="emoji">üß™</span> Quick Test Options</h3>
            <div class="buttons">
                <button onclick="testSingleFleet()">Test 15 BFNV Wagons</button>
                <button onclick="testMixedFleet()">Test 8 BOST + 6 BRN (Concord)</button>
                <button onclick="testComparison()">Compare BFNV vs Concord</button>
            </div>
        </div>
        
        <!-- Results Section (Step 1) -->
        <div id="results" class="results hidden">
            <h2><span class="emoji">üìä</span> Optimization Results</h2>
            <div id="stats" class="stats"></div>
        </div>
        
        <!-- Efficiency Display (Step 2) -->
        <div id="efficiencyDisplay" class="efficiency-display hidden">
            <div class="efficiency-header">
                <span class="emoji">üìà</span>
                <h3>Wagon Efficiency Distribution</h3>
            </div>
            <div class="efficiency-chart" id="efficiencyChart">            </div>
        </div>
        
        <!-- Visual Wagon Display (Step 3) -->
        <div id="visualDisplay" class="visual-display hidden">
            <h2><span class="emoji">üöõ</span> Visual Wagon Loading Display</h2>
            <div id="wagonGrid" class="wagon-grid"></div>
        </div>
        
        <!-- Export Section (Step 4) -->
        <div id="exportSection" class="export-section hidden">
            <h3><span class="emoji">üì§</span> Export Results</h3>
            <button onclick="generateCSVDisplay()" class="copy-btn">
                <span class="emoji">üìã</span> Generate CSV Data
            </button>
            <div id="csvDisplay" class="csv-display hidden">
                <div class="csv-content" id="csvContent"></div>
                <button onclick="copyCSVToClipboard()" class="copy-btn">
                    <span class="emoji">üìã</span> Copy to Clipboard
                </button>
            </div>
        </div>
        
        <!-- Terminal Output (Step 5) -->
        <div id="terminalSection" class="results hidden">
            <div id="output" class="output"></div>
        </div>
    </div>

    <script>
        // Enhanced Coil Loading Optimizer Implementation with Position Constraints
        class EnhancedCoilLoadingOptimizer {
            constructor(wagonCapacity = 68.6, maxWeightDiff = 2.0, positionLimits = [35, 23, 35]) {
                this.wagonCapacity = wagonCapacity;
                this.maxWeightDiff = maxWeightDiff;
                this.positionLimits = positionLimits;
                this.valid3CoilCombos = [];
                this.valid2CoilCombos = [];
                this.selectedCombinations = [];
                this.usedCoils = new Set();
                this.mixedFleet = false;
                this.wagonFleet = [];
                
                // Updated wagon capacities
                this.wagonCapacities = {
                    'BRN 22.9': 67.3,
                    'BFNS': 63.8,
                    'BFNSM': 69.1,
                    'BOXN': 66.1,
                    'BOXNHS': 64.0,
                    'BOXNHL': 66.0,
                    'BOST': 65.1,
                    'BRN': 62.6
                };
            }

            parseCoilData(rawData) {
                return rawData.split('\n').map(item => {
                    const [id, weight] = item.split(',');
                    return { 
                        id: id.trim(), 
                        weight: parseFloat(weight) 
                    };
                }).filter(item => item.id && !isNaN(item.weight));
            }

            configureMixedFleet(fleet) {
                this.mixedFleet = true;
                this.wagonFleet = [];
                
                fleet.forEach(wagonType => {
                    for (let i = 0; i < wagonType.count; i++) {
                        this.wagonFleet.push({
                            id: `${wagonType.type}-${i + 1}`,
                            type: wagonType.type,
                            capacity: wagonType.capacity,
                            positionLimits: wagonType.positionLimits || [35, 30, 35]
                        });
                    }
                });
                
                this.wagonFleet.sort((a, b) => b.capacity - a.capacity);
                
                this.log(`üöõ Mixed fleet configured: ${this.wagonFleet.length} wagons`);
                fleet.forEach(type => {
                    this.log(`   - ${type.count} ${type.type} wagons (${type.capacity}t capacity, pos limits: ${type.positionLimits.join('/')}t)`);
                });
            }

            checkPositionConstraints(coils, positionLimits) {
                if (coils.length === 1) {
                    return coils[0].weight <= Math.max(...positionLimits);
                } else if (coils.length === 2) {
                    const [coil1, coil2] = coils;
                    
                    // For 2 coils, only use front (0) and rear (2) positions
                    const combinations = [
                        [0, 2]  // Only front and rear
                    ];
                    
                    for (const [pos1, pos2] of combinations) {
                        if (coil1.weight <= positionLimits[pos1] && coil2.weight <= positionLimits[pos2]) {
                            return { valid: true, positions: [pos1, pos2], assignment: [coil1, coil2] };
                        }
                        if (coil2.weight <= positionLimits[pos1] && coil1.weight <= positionLimits[pos2]) {
                            return { valid: true, positions: [pos1, pos2], assignment: [coil2, coil1] };
                        }
                    }
                    return { valid: false };
                } else if (coils.length === 3) {
                    const [end1, middle, end2] = coils;
                    
                    if (end1.weight <= positionLimits[0] && 
                        middle.weight <= positionLimits[1] && 
                        end2.weight <= positionLimits[2]) {
                        return { valid: true, positions: [0, 1, 2], assignment: [end1, middle, end2] };
                    }
                    
                    if (end2.weight <= positionLimits[0] && 
                        middle.weight <= positionLimits[1] && 
                        end1.weight <= positionLimits[2]) {
                        return { valid: true, positions: [0, 1, 2], assignment: [end2, middle, end1] };
                    }
                    
                    return { valid: false };
                }
                
                return { valid: false };
            }

            findMixedFleetCombinations(coils) {
                this.log("üîç Finding combinations for mixed wagon fleet with position constraints...");
                
                const uniqueConfigs = [];
                const configMap = new Map();
                
                this.wagonFleet.forEach(wagon => {
                    const key = `${wagon.capacity}-${wagon.positionLimits.join(',')}`;
                    if (!configMap.has(key)) {
                        configMap.set(key, {
                            capacity: wagon.capacity,
                            positionLimits: wagon.positionLimits,
                            threeCoil: [],
                            twoCoil: []
                        });
                        uniqueConfigs.push({ capacity: wagon.capacity, positionLimits: wagon.positionLimits });
                    }
                });
                
                this.combinationsByConfig = configMap;
                
                // Find 3-coil combinations
                for (let i = 0; i < coils.length; i++) {
                    for (let j = 0; j < coils.length; j++) {
                        for (let k = 0; k < coils.length; k++) {
                            if (i !== j && j !== k && i !== k) {
                                const end1 = coils[i];
                                const middle = coils[j];
                                const end2 = coils[k];
                                
                                const totalWeight = end1.weight + middle.weight + end2.weight;
                                const endDiff = Math.abs(end1.weight - end2.weight);
                                const middleOK = middle.weight < Math.min(end1.weight, end2.weight);
                                
                                if (endDiff <= this.maxWeightDiff && middleOK) {
                                    uniqueConfigs.forEach(config => {
                                        if (totalWeight <= config.capacity) {
                                            const posCheck = this.checkPositionConstraints([end1, middle, end2], config.positionLimits);
                                            if (posCheck.valid) {
                                                const key = `${config.capacity}-${config.positionLimits.join(',')}`;
                                                const combo = {
                                                    coils: posCheck.assignment,
                                                    totalWeight: totalWeight,
                                                    coilCount: 3,
                                                    endDiff: endDiff,
                                                    positions: posCheck.positions
                                                };
                                                this.combinationsByConfig.get(key).threeCoil.push(combo);
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    }
                }
                
                // Find 2-coil combinations
                for (let i = 0; i < coils.length; i++) {
                    for (let j = i + 1; j < coils.length; j++) {
                        const coil1 = coils[i];
                        const coil2 = coils[j];
                        const totalWeight = coil1.weight + coil2.weight;
                        const weightDiff = Math.abs(coil1.weight - coil2.weight);
                        
                        if (weightDiff <= this.maxWeightDiff) {
                            uniqueConfigs.forEach(config => {
                                if (totalWeight <= config.capacity) {
                                    const posCheck = this.checkPositionConstraints([coil1, coil2], config.positionLimits);
                                    if (posCheck.valid) {
                                        const key = `${config.capacity}-${config.positionLimits.join(',')}`;
                                        const combo = {
                                            coils: posCheck.assignment,
                                            totalWeight: totalWeight,
                                            coilCount: 2,
                                            weightDiff: weightDiff,
                                            positions: posCheck.positions
                                        };
                                        this.combinationsByConfig.get(key).twoCoil.push(combo);
                                    }
                                }
                            });
                        }
                    }
                }
                
                this.combinationsByConfig.forEach((combos, key) => {
                    const [capacity] = key.split('-');
                    const three = combos.threeCoil.length;
                    const two = combos.twoCoil.length;
                    this.log(`‚úÖ Config ${key}: ${three} 3-coil + ${two} 2-coil valid combinations`);
                });
            }

            optimizeMixedFleet() {
                this.log("üéØ Optimizing mixed wagon fleet loading with position constraints...");
                
                this.selectedCombinations = [];
                this.usedCoils = new Set();
                
                const wagonsByConfig = new Map();
                this.wagonFleet.forEach(wagon => {
                    const key = `${wagon.capacity}-${wagon.positionLimits.join(',')}`;
                    if (!wagonsByConfig.has(key)) {
                        wagonsByConfig.set(key, []);
                    }
                    wagonsByConfig.get(key).push(wagon);
                });
                
                const sortedConfigs = Array.from(wagonsByConfig.keys()).sort((a, b) => {
                    const [capA] = a.split('-').map(Number);
                    const [capB] = b.split('-').map(Number);
                    return capB - capA;
                });
                
                sortedConfigs.forEach(configKey => {
                    const wagonsOfThisConfig = wagonsByConfig.get(configKey);
                    const combinations = [
                        ...this.combinationsByConfig.get(configKey).threeCoil,
                        ...this.combinationsByConfig.get(configKey).twoCoil
                    ];
                    
                    combinations.sort((a, b) => {
                        if (a.coilCount !== b.coilCount) return b.coilCount - a.coilCount;
                        return b.totalWeight - a.totalWeight;
                    });
                    
                    this.log(`\nProcessing ${wagonsOfThisConfig.length} wagons with config ${configKey}:`);
                    
                    let wagonsUsed = 0;
                    for (const combo of combinations) {
                        if (wagonsUsed >= wagonsOfThisConfig.length) break;
                        
                        const conflicted = combo.coils.some(coil => this.usedCoils.has(coil.id));
                        if (!conflicted) {
                            const wagon = wagonsOfThisConfig[wagonsUsed];
                            
                            const wagonTypeUpper = wagon.type.toUpperCase();
                            const isRestrictedWagon = (wagonTypeUpper.startsWith('BRN') && wagonTypeUpper !== 'BRN 22.9') || 
                                                    (wagonTypeUpper.startsWith('BFNS') && wagonTypeUpper !== 'BFNS 22.9');
                            
                            if (isRestrictedWagon && combo.coilCount === 3) {
                                continue;
                            }
                            
                            combo.coils.forEach(coil => this.usedCoils.add(coil.id));
                            
                            this.selectedCombinations.push({
                                wagon: wagon,
                                combination: combo
                            });
                            
                            const coilDesc = combo.coils.map((c, idx) => 
                                `Pos${combo.positions[idx] + 1}:${c.id}(${c.weight}t)`).join(' | ');
                            const efficiency = (combo.totalWeight / wagon.capacity * 100).toFixed(1);
                            this.log(`  ${wagon.id}: [${combo.coilCount} coils] ${coilDesc} = ${combo.totalWeight.toFixed(1)}t (${efficiency}%)`);
                            
                            wagonsUsed++;
                        }
                    }
                });
            }

            isValid3CoilComboWithPositions(end1, middle, end2, positionLimits) {
                const totalWeight = end1.weight + middle.weight + end2.weight;
                const endDiff = Math.abs(end1.weight - end2.weight);
                const middleOK = middle.weight < Math.min(end1.weight, end2.weight);
                
                if (totalWeight > this.wagonCapacity || endDiff > this.maxWeightDiff || !middleOK) {
                    return false;
                }
                
                const posCheck = this.checkPositionConstraints([end1, middle, end2], positionLimits);
                return posCheck.valid;
            }

            isValid2CoilComboWithPositions(coil1, coil2, positionLimits) {
                const totalWeight = coil1.weight + coil2.weight;
                const weightDiff = Math.abs(coil1.weight - coil2.weight);
                
                if (totalWeight > this.wagonCapacity || weightDiff > this.maxWeightDiff) {
                    return false;
                }
                
                const posCheck = this.checkPositionConstraints([coil1, coil2], positionLimits);
                return posCheck.valid;
            }

            findValid3CoilCombinations(coils) {
                this.log("üîç Finding valid 3-coil combinations with position constraints...");
                this.valid3CoilCombos = [];
                
                for (let i = 0; i < coils.length; i++) {
                    for (let j = 0; j < coils.length; j++) {
                        for (let k = 0; k < coils.length; k++) {
                            if (i !== j && j !== k && i !== k) {
                                const end1 = coils[i];
                                const middle = coils[j]; 
                                const end2 = coils[k];
                                
                                if (this.isValid3CoilComboWithPositions(end1, middle, end2, this.positionLimits)) {
                                    const posCheck = this.checkPositionConstraints([end1, middle, end2], this.positionLimits);
                                    this.valid3CoilCombos.push({
                                        coils: posCheck.assignment,
                                        totalWeight: end1.weight + middle.weight + end2.weight,
                                        coilCount: 3,
                                        endDiff: Math.abs(end1.weight - end2.weight),
                                        efficiency: ((end1.weight + middle.weight + end2.weight) / this.wagonCapacity * 100),
                                        positions: posCheck.positions
                                    });
                                }
                            }
                        }
                    }
                }
                
                this.log(`‚úÖ Found ${this.valid3CoilCombos.length} valid 3-coil combinations`);
            }

            findValid2CoilCombinations(coils) {
                this.log("üîç Finding valid 2-coil combinations with position constraints...");
                this.valid2CoilCombos = [];
                
                for (let i = 0; i < coils.length; i++) {
                    for (let j = i + 1; j < coils.length; j++) {
                        const coil1 = coils[i];
                        const coil2 = coils[j];
                        
                        if (this.isValid2CoilComboWithPositions(coil1, coil2, this.positionLimits)) {
                            const posCheck = this.checkPositionConstraints([coil1, coil2], this.positionLimits);
                            this.valid2CoilCombos.push({
                                coils: posCheck.assignment,
                                totalWeight: coil1.weight + coil2.weight,
                                coilCount: 2,
                                weightDiff: Math.abs(coil1.weight - coil2.weight),
                                efficiency: ((coil1.weight + coil2.weight) / this.wagonCapacity * 100),
                                positions: posCheck.positions
                            });
                        }
                    }
                }
                
                this.log(`‚úÖ Found ${this.valid2CoilCombos.length} valid 2-coil combinations`);
            }

            optimizeLoading(numWagons) {
                this.log("üéØ Applying optimization algorithm with position constraints...");
                
                const allCombinations = [...this.valid3CoilCombos, ...this.valid2CoilCombos];
                
                allCombinations.sort((a, b) => {
                    if (a.coilCount !== b.coilCount) return b.coilCount - a.coilCount;
                    return b.totalWeight - a.totalWeight;
                });

                this.selectedCombinations = [];
                this.usedCoils = new Set();

                for (const combo of allCombinations) {
                    const conflicted = combo.coils.some(coil => this.usedCoils.has(coil.id));
                    
                    if (!conflicted) {
                        this.selectedCombinations.push(combo);
                        combo.coils.forEach(coil => this.usedCoils.add(coil.id));
                        
                        if (this.selectedCombinations.length === numWagons) {
                            break;
                        }
                    }
                }
                
                this.log(`‚úÖ Selected ${this.selectedCombinations.length} optimal combinations`);
            }

            handleRemainingCoils(coils, numWagons) {
                const remainingCoils = coils.filter(c => !this.usedCoils.has(c.id));
                const unusedWagons = numWagons - this.selectedCombinations.length;
                
                if (remainingCoils.length > 0 && unusedWagons > 0) {
                    this.log(`üîç Handling ${remainingCoils.length} remaining coils with ${unusedWagons} unused wagons`);
                    
                    remainingCoils.sort((a, b) => b.weight - a.weight);
                    
                    const coilsToLoadAsSingles = Math.min(remainingCoils.length, unusedWagons);
                    
                    for (let i = 0; i < coilsToLoadAsSingles; i++) {
                        const coil = remainingCoils[i];
                        if (coil.weight <= this.wagonCapacity && 
                            coil.weight <= Math.max(...this.positionLimits)) {
                            
                            let bestPos = 0;
                            for (let pos = 0; pos < this.positionLimits.length; pos++) {
                                if (coil.weight <= this.positionLimits[pos]) {
                                    bestPos = pos;
                                    break;
                                }
                            }
                            
                            this.selectedCombinations.push({
                                coils: [coil],
                                totalWeight: coil.weight,
                                coilCount: 1,
                                efficiency: (coil.weight / this.wagonCapacity * 100),
                                positions: [bestPos]
                            });
                            this.usedCoils.add(coil.id);
                        }
                    }
                }
            }

            generateReport(coils, numWagons) {
                const totalDatasetWeight = coils.reduce((sum, c) => sum + c.weight, 0);
                const totalLoadedWeight = this.selectedCombinations.reduce((sum, combo) => sum + combo.totalWeight, 0);
                const remainingCoils = coils.filter(c => !this.usedCoils.has(c.id));
                
                this.log("\n" + "=".repeat(60));
                this.log("üìä ENHANCED LOADING OPTIMIZATION REPORT");
                this.log("=".repeat(60));
                
                this.log(`\nüìã DATASET OVERVIEW:`);
                this.log(`Total coils: ${coils.length}`);
                this.log(`Total weight: ${totalDatasetWeight.toFixed(1)}t`);
                this.log(`Available wagons: ${numWagons} (${this.wagonCapacity}t capacity each)`);
                this.log(`Position limits: Front=${this.positionLimits[0]}t, Middle=${this.positionLimits[1]}t, Rear=${this.positionLimits[2]}t`);
                this.log(`Total capacity: ${(numWagons * this.wagonCapacity).toFixed(1)}t`);
                
                this.log(`\nüéØ OPTIMIZATION RESULTS:`);
                this.log(`‚úÖ Coils loaded: ${this.usedCoils.size}/${coils.length} (${(this.usedCoils.size/coils.length*100).toFixed(1)}%)`);
                this.log(`üöõ Wagons used: ${this.selectedCombinations.length}/${numWagons}`);
                this.log(`‚öñÔ∏è Weight loaded: ${totalLoadedWeight.toFixed(1)}t/${totalDatasetWeight.toFixed(1)}t (${(totalLoadedWeight/totalDatasetWeight*100).toFixed(1)}%)`);
                this.log(`üìà Avg wagon efficiency: ${(totalLoadedWeight/(this.selectedCombinations.length * this.wagonCapacity)*100).toFixed(1)}%`);
                
                this.log(`\nüì¶ DETAILED LOADING SCHEDULE WITH POSITIONS:`);
                
                let wagon3Count = 0, wagon2Count = 0, wagon1Count = 0;
                
                this.selectedCombinations.forEach((combo, index) => {
                    const positionNames = ['Front', 'Middle', 'Rear'];
                    const coilDesc = combo.coils.map((c, idx) => 
                        `${positionNames[combo.positions[idx]]}:${c.id}(${c.weight}t)`).join(' | ');
                    const efficiency = combo.efficiency.toFixed(1);
                    this.log(`Wagon ${index + 1}: [${combo.coilCount} coils] ${coilDesc} = ${combo.totalWeight.toFixed(1)}t (${efficiency}%)`);
                    
                    if (combo.coilCount === 3) wagon3Count++;
                    else if (combo.coilCount === 2) wagon2Count++;
                    else wagon1Count++;
                });
                
                this.log(`\nüìä LOADING CONFIGURATION:`);
                if (wagon3Count > 0) this.log(`- ${wagon3Count} wagons: 3-coil loading (${wagon3Count * 3} coils)`);
                if (wagon2Count > 0) this.log(`- ${wagon2Count} wagons: 2-coil loading (${wagon2Count * 2} coils)`);
                if (wagon1Count > 0) this.log(`- ${wagon1Count} wagons: single-coil loading (${wagon1Count} coils)`);
                
                const unusedWagons = numWagons - this.selectedCombinations.length;
                if (unusedWagons > 0) this.log(`- ${unusedWagons} wagons: unused (spare capacity)`);
                
                if (remainingCoils.length > 0) {
                    this.log(`\nüìã UNLOADED COILS (${remainingCoils.length}):`);
                    remainingCoils.forEach(coil => {
                        const reason = coil.weight > this.wagonCapacity ? 
                            `(exceeds wagon capacity ${this.wagonCapacity}t)` :
                            coil.weight > Math.max(...this.positionLimits) ?
                            `(exceeds max position limit ${Math.max(...this.positionLimits)}t)` :
                            `(no optimal combination found)`;
                        this.log(`${coil.id}: ${coil.weight}t ${reason}`);
                    });
                } else {
                    this.log(`\nüéâ ALL COILS LOADED! Perfect 100% utilization achieved!`);
                }
                
                return {
                    coilsLoaded: this.usedCoils.size,
                    totalCoils: coils.length,
                    utilizationPercent: (this.usedCoils.size/coils.length*100),
                    wagonsUsed: this.selectedCombinations.length,
                    totalWagons: numWagons,
                    loadingSchedule: this.selectedCombinations,
                    remainingCoils: remainingCoils
                };
            }

            generateMixedFleetReport(coils) {
                const totalDatasetWeight = coils.reduce((sum, c) => sum + c.weight, 0);
                const totalLoadedWeight = this.selectedCombinations.reduce((sum, item) => sum + item.combination.totalWeight, 0);
                const remainingCoils = coils.filter(c => !this.usedCoils.has(c.id));
                
                this.log("\n" + "=".repeat(70));
                this.log("üìä ENHANCED MIXED WAGON FLEET OPTIMIZATION REPORT");
                this.log("=".repeat(70));
                
                const fleetSummary = {};
                this.wagonFleet.forEach(wagon => {
                    if (!fleetSummary[wagon.type]) {
                        fleetSummary[wagon.type] = { 
                            count: 0, 
                            capacity: wagon.capacity,
                            positionLimits: wagon.positionLimits 
                        };
                    }
                    fleetSummary[wagon.type].count++;
                });
                
                this.log(`\nüöõ FLEET CONFIGURATION:`);
                Object.keys(fleetSummary).forEach(type => {
                    const info = fleetSummary[type];
                    this.log(`   - ${info.count} ${type} wagons (${info.capacity}t capacity, pos limits: ${info.positionLimits.join('/')}t)`);
                });
                
                this.log(`\nüéØ OPTIMIZATION RESULTS:`);
                this.log(`‚úÖ Coils loaded: ${this.usedCoils.size}/${coils.length} (${(this.usedCoils.size/coils.length*100).toFixed(1)}%)`);
                this.log(`üöõ Wagons used: ${this.selectedCombinations.length}/${this.wagonFleet.length}`);
                this.log(`‚öñÔ∏è Weight loaded: ${totalLoadedWeight.toFixed(1)}t/${totalDatasetWeight.toFixed(1)}t (${(totalLoadedWeight/totalDatasetWeight*100).toFixed(1)}%)`);
                
                const usageByType = {};
                this.selectedCombinations.forEach(item => {
                    const type = item.wagon.type;
                    if (!usageByType[type]) usageByType[type] = { used: 0, total: fleetSummary[type].count };
                    usageByType[type].used++;
                });
                
                this.log(`\nüì¶ WAGON USAGE BY TYPE:`);
                Object.keys(usageByType).forEach(type => {
                    const usage = usageByType[type];
                    this.log(`   - ${type}: ${usage.used}/${usage.total} used (${(usage.used/usage.total*100).toFixed(1)}%)`);
                });
                
                this.log(`\nüìã DETAILED LOADING SCHEDULE WITH POSITIONS:`);
                this.selectedCombinations.forEach((item, index) => {
                    const combo = item.combination;
                    const wagon = item.wagon;
                    const positionNames = ['Front', 'Middle', 'Rear'];
                    const coilDesc = combo.coils.map((c, idx) => 
                        `${positionNames[combo.positions[idx]]}:${c.id}(${c.weight}t)`).join(' | ');
                    const efficiency = (combo.totalWeight / wagon.capacity * 100).toFixed(1);
                    this.log(`${wagon.id}: [${combo.coilCount} coils] ${coilDesc} = ${combo.totalWeight.toFixed(1)}t (${efficiency}%)`);
                });
                
                if (remainingCoils.length > 0) {
                    this.log(`\nüìã UNLOADED COILS (${remainingCoils.length}):`);
                    remainingCoils.forEach(coil => {
                        this.log(`${coil.id}: ${coil.weight}t`);
                    });
                    
                    const unusedWagons = this.wagonFleet.length - this.selectedCombinations.length;
                    if (unusedWagons > 0) {
                        this.log(`\nüí° ${unusedWagons} unused wagons available for singles loading`);
                    }
                } else {
                    this.log(`\nüéâ ALL COILS LOADED! Perfect 100% utilization achieved!`);
                }
                
                return {
                    coilsLoaded: this.usedCoils.size,
                    totalCoils: coils.length,
                    utilizationPercent: (this.usedCoils.size/coils.length*100),
                    wagonsUsed: this.selectedCombinations.length,
                    totalWagons: this.wagonFleet.length,
                    loadingSchedule: this.selectedCombinations,
                    remainingCoils: remainingCoils,
                    fleetConfiguration: fleetSummary
                };
            }

            optimize(rawData, wagons, positionLimits) {
                this.log("üöÄ Starting enhanced coil loading optimization with position constraints...");
                this.outputBuffer = [];
                
                const coils = this.parseCoilData(rawData);
                
                if (Array.isArray(wagons)) {
                    this.configureMixedFleet(wagons);
                    this.findMixedFleetCombinations(coils);
                    this.optimizeMixedFleet();
                    return this.generateMixedFleetReport(coils);
                } else {
                    this.positionLimits = positionLimits || this.positionLimits;
                    this.findValid3CoilCombinations(coils);
                    this.findValid2CoilCombinations(coils);
                    this.optimizeLoading(wagons);
                    this.handleRemainingCoils(coils, wagons);
                    return this.generateReport(coils, wagons);
                }
            }

            log(message) {
                console.log(message);
                if (!this.outputBuffer) this.outputBuffer = [];
                this.outputBuffer.push(message);
            }

            getOutput() {
                return this.outputBuffer ? this.outputBuffer.join('\n') : '';
            }
        }

        // Global variables for results
        let currentResults = null;
        let currentOptimizer = null;

        // UI Functions
        function toggleFleetConfig() {
            const wagonType = document.getElementById('wagonType').value;
            const singleConfig = document.getElementById('singleWagonConfig');
            const mixedConfig = document.getElementById('mixedFleetConfig');
            
            if (wagonType === 'mixed') {
                singleConfig.style.display = 'none';
                mixedConfig.style.display = 'block';
            } else {
                singleConfig.style.display = 'block';
                mixedConfig.style.display = 'none';
            }
        }

        function addFleetItem() {
            const fleetItems = document.getElementById('fleetItems');
            const newItem = document.createElement('div');
            newItem.className = 'fleet-item';
            newItem.innerHTML = `
                <div class="fleet-basic-info">
                    <div>
                        <label>Wagon Type:</label>
                        <input type="text" placeholder="e.g., BFNV">
                    </div>
                    <div>
                        <label>Capacity (tons):</label>
                        <input type="number" placeholder="68.6" step="0.1">
                    </div>
                    <div>
                        <label>Count:</label>
                        <input type="number" placeholder="10" min="1">
                    </div>
                    <div>
                        <button type="button" onclick="this.parentElement.parentElement.remove()" class="remove-btn">Remove</button>
                    </div>
                </div>
                <div class="position-constraints">
                    <h4>Position Weight Limits (tons)</h4>
                    <div class="position-row">
                        <div class="position-input">
                            <label>Position 1 (Front)</label>
                            <input type="number" value="32" step="0.1" min="0">
                        </div>
                        <div class="position-input">
                            <label>Position 2 (Middle)</label>
                            <input type="number" value="22" step="0.1" min="0">
                        </div>
                        <div class="position-input">
                            <label>Position 3 (Rear)</label>
                            <input type="number" value="32" step="0.1" min="0">
                        </div>
                    </div>
                </div>
            `;
            fleetItems.appendChild(newItem);
        }

        function runOptimization() {
            const coilData = document.getElementById('coilData').value.trim();
            const maxWeightDiff = parseFloat(document.getElementById('maxWeightDiff').value);
            const wagonType = document.getElementById('wagonType').value;
            
            if (!coilData) {
                alert('Please enter coil data');
                return;
            }
            
            let optimizer, wagons, results, positionLimits;
            
            if (wagonType === 'single') {
                const wagonCapacity = parseFloat(document.getElementById('wagonCapacity').value);
                const numWagons = parseInt(document.getElementById('numWagons').value);
                
                positionLimits = [
                    parseFloat(document.getElementById('singlePos1').value),
                    parseFloat(document.getElementById('singlePos2').value),
                    parseFloat(document.getElementById('singlePos3').value)
                ];
                
                optimizer = new EnhancedCoilLoadingOptimizer(wagonCapacity, maxWeightDiff, positionLimits);
                results = optimizer.optimize(coilData, numWagons, positionLimits);
            } else {
                const fleetItems = document.querySelectorAll('#fleetItems .fleet-item');
                const mixedFleet = [];
                
                fleetItems.forEach(item => {
                    const basicInputs = item.querySelectorAll('.fleet-basic-info input');
                    const posInputs = item.querySelectorAll('.position-constraints input');
                    
                    const type = basicInputs[0].value.trim();
                    const capacity = parseFloat(basicInputs[1].value);
                    const count = parseInt(basicInputs[2].value);
                    
                    const posLimits = [
                        parseFloat(posInputs[0].value),
                        parseFloat(posInputs[1].value),
                        parseFloat(posInputs[2].value)
                    ];
                    
                    if (type && !isNaN(capacity) && !isNaN(count) && count > 0) {
                        mixedFleet.push({ type, capacity, count, positionLimits: posLimits });
                    }
                });
                
                if (mixedFleet.length === 0) {
                    alert('Please configure at least one wagon type for mixed fleet');
                    return;
                }
                
                optimizer = new EnhancedCoilLoadingOptimizer(68.6, maxWeightDiff);
                results = optimizer.optimize(coilData, mixedFleet);
            }
            
            currentResults = results;
            currentOptimizer = optimizer;
            
            // Display results in the new order
            displayResults(results);
            displayEfficiencyChart(results);
            displayVisualWagons(results);
            displayExportSection();
            displayTerminalOutput(optimizer.getOutput());
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('stats');
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.coilsLoaded}/${results.totalCoils}</div>
                    <div class="stat-label">Coils Loaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.utilizationPercent.toFixed(1)}%</div>
                    <div class="stat-label">Utilization Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.wagonsUsed}/${results.totalWagons}</div>
                    <div class="stat-label">Wagons Used</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.loadingSchedule.length}</div>
                    <div class="stat-label">Loading Operations</div>
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayEfficiencyChart(results) {
            const efficiencyDiv = document.getElementById('efficiencyDisplay');
            const chartDiv = document.getElementById('efficiencyChart');
            
            let highCount = 0, mediumCount = 0, lowCount = 0;
            const unusedCount = results.totalWagons - results.wagonsUsed;
            
            results.loadingSchedule.forEach(item => {
                let efficiency;
                if (item.wagon) {
                    // Mixed fleet
                    efficiency = (item.combination.totalWeight / item.wagon.capacity) * 100;
                } else {
                    // Single fleet
                    efficiency = (item.totalWeight / currentOptimizer.wagonCapacity) * 100;
                }
                
                if (efficiency >= 90) highCount++;
                else if (efficiency >= 70) mediumCount++;
                else lowCount++;
            });
            
            chartDiv.innerHTML = `
                <div class="efficiency-category">
                    <div class="efficiency-circle efficiency-high">
                        ${highCount}
                    </div>
                    <div class="efficiency-label">
                        <span class="efficiency-indicator high"></span>HIGH EFFICIENCY (‚â•90%)
                    </div>
                </div>
                <div class="efficiency-category">
                    <div class="efficiency-circle efficiency-medium">
                        ${mediumCount}
                    </div>
                    <div class="efficiency-label">
                        <span class="efficiency-indicator medium"></span>MEDIUM EFFICIENCY (70-89%)
                    </div>
                </div>
                <div class="efficiency-category">
                    <div class="efficiency-circle efficiency-low">
                        ${lowCount}
                    </div>
                    <div class="efficiency-label">
                        <span class="efficiency-indicator low"></span>LOW EFFICIENCY (<70%)
                    </div>
                </div>
                <div class="efficiency-category">
                    <div class="efficiency-circle efficiency-unused">
                        ${unusedCount}
                    </div>
                    <div class="efficiency-label">
                        <span class="efficiency-indicator unused"></span>UNUSED WAGONS
                    </div>
                </div>
            `;
            
            efficiencyDiv.classList.remove('hidden');
        }

        function displayVisualWagons(results) {
            const visualDiv = document.getElementById('visualDisplay');
            const wagonGrid = document.getElementById('wagonGrid');
            
            wagonGrid.innerHTML = '';
            
            results.loadingSchedule.forEach((item, index) => {
                const wagonCard = document.createElement('div');
                wagonCard.className = 'wagon-card';
                
                let combo, wagonInfo, capacity;
                if (item.wagon) {
                    // Mixed fleet
                    combo = item.combination;
                    capacity = item.wagon.capacity;
                    wagonInfo = `${item.wagon.id} | Capacity: ${capacity}t`;
                } else {
                    // Single fleet
                    combo = item;
                    capacity = currentOptimizer.wagonCapacity;
                    wagonInfo = `Wagon ${index + 1} | Capacity: ${capacity}t`;
                }
                
                const efficiency = (combo.totalWeight / capacity) * 100;
                
                // Set efficiency class for border color
                if (efficiency < 70) {
                    wagonCard.classList.add('low-efficiency');
                } else if (efficiency < 90) {
                    wagonCard.classList.add('medium-efficiency');
                }
                
                let coilPositions = ['', '', ''];
                combo.coils.forEach((coil, idx) => {
                    const pos = combo.positions[idx];
                    coilPositions[pos] = `<div class="coil-id">${coil.id}</div><div class="coil-weight">${coil.weight}t</div>`;
                });
                
                let efficiencyClass = 'wagon-efficiency';
                let progressClass = 'efficiency-progress';
                if (efficiency < 70) {
                    efficiencyClass += ' low';
                    progressClass += ' low';
                } else if (efficiency < 90) {
                    efficiencyClass += ' medium';
                    progressClass += ' medium';
                } else {
                    progressClass += ' high';
                }
                
                wagonCard.innerHTML = `
                    <div class="wagon-header">
                        <div class="wagon-title">
                            <span class="emoji">üöõ</span>
                            ${item.wagon ? item.wagon.type : 'Wagon'} ${index + 1}
                        </div>
                        <div class="${efficiencyClass}">${efficiency.toFixed(1)}%</div>
                    </div>
                    <div class="wagon-layout">
                        <div class="coil-position front ${coilPositions[0] ? '' : 'empty'}">
                            ${coilPositions[0] || '<div class="coil-id">Empty</div><div class="coil-weight">Front</div>'}
                        </div>
                        <div class="coil-position middle ${coilPositions[1] ? '' : 'empty'}">
                            ${coilPositions[1] || '<div class="coil-id">Empty</div><div class="coil-weight">Middle</div>'}
                        </div>
                        <div class="coil-position rear ${coilPositions[2] ? '' : 'empty'}">
                            ${coilPositions[2] || '<div class="coil-id">Empty</div><div class="coil-weight">Rear</div>'}
                        </div>
                    </div>
                    <div class="efficiency-bar">
                        <div class="${progressClass}" style="width: ${efficiency.toFixed(1)}%"></div>
                    </div>
                    <div class="wagon-info">
                        <span>Load: ${combo.totalWeight.toFixed(1)}t</span>
                        <span>${wagonInfo}</span>
                        <span>Coils: ${combo.coilCount}</span>
                    </div>
                `;
                
                wagonGrid.appendChild(wagonCard);
            });
            
            visualDiv.classList.remove('hidden');
        }

        function displayExportSection() {
            const exportSection = document.getElementById('exportSection');
            exportSection.classList.remove('hidden');
        }

        function displayTerminalOutput(output) {
            const terminalSection = document.getElementById('terminalSection');
            const outputDiv = document.getElementById('output');
            
            outputDiv.textContent = output;
            terminalSection.classList.remove('hidden');
        }

        function generateCSVDisplay() {
            if (!currentResults) {
                alert('Please run optimization first');
                return;
            }
            
            let csvContent = "Wagon,Coil_1_ID,Coil_1_Weight,Coil_2_ID,Coil_2_Weight,Coil_3_ID,Coil_3_Weight,Total_Weight,Efficiency,Capacity\n";
            
            currentResults.loadingSchedule.forEach((item, index) => {
                let combo, capacity;
                if (item.wagon) {
                    combo = item.combination;
                    capacity = item.wagon.capacity;
                } else {
                    combo = item;
                    capacity = currentOptimizer.wagonCapacity;
                }
                
                const efficiency = (combo.totalWeight / capacity * 100).toFixed(1);
                
                let coilData = ["", "", "", "", "", ""];
                combo.coils.forEach((coil, idx) => {
                    const pos = combo.positions[idx];
                    if (pos === 0) { // Front
                        coilData[0] = coil.id;
                        coilData[1] = coil.weight;
                    } else if (pos === 1) { // Middle
                        coilData[2] = coil.id;
                        coilData[3] = coil.weight;
                    } else if (pos === 2) { // Rear
                        coilData[4] = coil.id;
                        coilData[5] = coil.weight;
                    }
                });
                
                csvContent += `Wagon_${index + 1},${coilData[0]},${coilData[1]},${coilData[2]},${coilData[3]},${coilData[4]},${coilData[5]},${combo.totalWeight.toFixed(1)},${efficiency}%,${capacity}\n`;
            });
            
            document.getElementById('csvContent').textContent = csvContent;
            document.getElementById('csvDisplay').classList.remove('hidden');
        }

        function copyCSVToClipboard() {
            const csvContent = document.getElementById('csvContent').textContent;
            navigator.clipboard.writeText(csvContent).then(() => {
                alert('CSV data copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        function testSingleFleet() {
            document.getElementById('wagonType').value = 'single';
            document.getElementById('wagonCapacity').value = '68.6';
            document.getElementById('numWagons').value = '15';
            document.getElementById('singlePos1').value = '32';
            document.getElementById('singlePos2').value = '23';
            document.getElementById('singlePos3').value = '32';
            toggleFleetConfig();
            runOptimization();
        }

        function testMixedFleet() {
            document.getElementById('wagonType').value = 'mixed';
            toggleFleetConfig();
            
            const fleetItems = document.querySelectorAll('#fleetItems .fleet-item');
            if (fleetItems.length >= 2) {
                const bost = fleetItems[0];
                const bostBasic = bost.querySelectorAll('.fleet-basic-info input');
                const bostPos = bost.querySelectorAll('.position-constraints input');
                bostBasic[0].value = 'BOST';
                bostBasic[1].value = '65.1';
                bostBasic[2].value = '8';
                bostPos[0].value = '32';
                bostPos[1].value = '22';
                bostPos[2].value = '32';
                
                const brn = fleetItems[1];
                const brnBasic = brn.querySelectorAll('.fleet-basic-info input');
                const brnPos = brn.querySelectorAll('.position-constraints input');
                brnBasic[0].value = 'BRN';
                brnBasic[1].value = '62.6';
                brnBasic[2].value = '6';
                brnPos[0].value = '32';
                brnPos[1].value = '22';
                brnPos[2].value = '32';
            }
            
            runOptimization();
        }

        function testComparison() {
            const coilData = document.getElementById('coilData').value.trim();
            
            const optimizer1 = new EnhancedCoilLoadingOptimizer(68.6, 2.0, [32, 23, 32]);
            const results1 = optimizer1.optimize(coilData, 15, [32, 23, 32]);
            
            const optimizer2 = new EnhancedCoilLoadingOptimizer(68.6, 2.0);
            const mixedFleet = [
                { type: 'BOST', capacity: 65.1, count: 8, positionLimits: [32, 22, 32] },
                { type: 'BRN', capacity: 62.6, count: 6, positionLimits: [32, 22, 32] }
            ];
            const results2 = optimizer2.optimize(coilData, mixedFleet);
            
            if (results1.utilizationPercent > results2.utilizationPercent) {
                currentResults = results1;
                currentOptimizer = optimizer1;
            } else {
                currentResults = results2;
                currentOptimizer = optimizer2;
            }
            
            const comparisonOutput = `
=== ENHANCED COMPARISON RESULTS ===

üìä BFNV FLEET (15 BFNV WAGONS) WITH POSITION CONSTRAINTS:
‚úÖ Coils loaded: ${results1.coilsLoaded}/${results1.totalCoils} (${results1.utilizationPercent.toFixed(1)}%)
üöõ Wagons used: ${results1.wagonsUsed}/${results1.totalWagons}
üìç Position limits: 32/23/32t

üìä CONCORD FLEET (8 BOST + 6 BRN) WITH POSITION CONSTRAINTS:
‚úÖ Coils loaded: ${results2.coilsLoaded}/${results2.totalCoils} (${results2.utilizationPercent.toFixed(1)}%)
üöõ Wagons used: ${results2.wagonsUsed}/${results2.totalWagons}
üìç BOST limits: 32/22/32t, BRN limits: 32/22/32t

üèÜ WINNER: ${results1.utilizationPercent > results2.utilizationPercent ? 'BFNV Fleet' : 
              results2.utilizationPercent > results1.utilizationPercent ? 'Concord Fleet' : 'Tie'}
            `;
            
            const combinedOutput = optimizer1.getOutput() + '\n\n' + optimizer2.getOutput() + '\n\n' + comparisonOutput;
            
            const bestResults = results1.utilizationPercent > results2.utilizationPercent ? results1 : results2;
            const bestOptimizer = results1.utilizationPercent > results2.utilizationPercent ? optimizer1 : optimizer2;
            
            displayResults(bestResults);
            displayEfficiencyChart(bestResults);
            displayVisualWagons(bestResults);
            displayExportSection();
            displayTerminalOutput(combinedOutput);
        }

        function runExample() {
            testSingleFleet();
        }

        function clearResults() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('efficiencyDisplay').classList.add('hidden');
            document.getElementById('visualDisplay').classList.add('hidden');
            document.getElementById('exportSection').classList.add('hidden');
            document.getElementById('terminalSection').classList.add('hidden');
            document.getElementById('csvDisplay').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', function() {
            toggleFleetConfig();
        });
    </script>
</body>
</html>